let offset;function fakeScroll(){window.scrollBy(0,2),window.scrollBy(0,-2)}function scrollByOffset(){document.children[0].getBoundingClientRect().height-(window.scrollY+window.innerHeight)>1&&(window.scrollBy(0,-1*offset),fakeScroll())}function keyboardNav(e){let l=Object.assign({postSelector:".post",postContainerSelector:"#posts",postOffset:0,nextPageSelector:"#next",prevPageSelector:"#prev",searchSelector:"#q",reblogSelector:".customreblog",paletteToggleSelector:"#palette"},e),t=document.querySelectorAll(l.postSelector),o=l.postContainerSelector===document?document:document.querySelector(l.postContainerSelector),r=document.querySelector(l.nextPageSelector),c=document.querySelector(l.prevPageSelector),s=document.querySelector(l.searchSelector),n,i,f;offset=l.postOffset??0;let a=new IntersectionObserver(e=>{for(let l of e)l.isIntersecting&&(n=l.target)},{rootMargin:`-${offset}px 0px -${window.innerHeight-offset}px`});t.forEach((e,l)=>{a.observe(e),e.setAttribute("tabindex","-1")}),document.addEventListener("keydown",e=>{let a=e.key.toUpperCase();if("INPUT"!==document.activeElement.tagName){if("J"===a){if(null==n)(n=t[0]).scrollIntoView(),scrollByOffset(),n.focus();else if((f=n.getBoundingClientRect().y)>offset+2)n.scrollIntoView(),scrollByOffset(),n.focus();else if(null!=n.nextElementSibling){i=n;let g=n.nextElementSibling;for(;g&&!g.matches(l.postSelector);)g=g.nextElementSibling;if(!g)return;g.scrollIntoView(),n==i&&(n=g),scrollByOffset(),n.focus()}else o.scrollIntoView(!1),window.scrollBy(0,20);l.scrollCallback&&l.scrollCallback()}else if("K"===a){if(null==n)(n=t[0]).scrollIntoView(),scrollByOffset();else if(-2-offset>(f=n.getBoundingClientRect().y))n.scrollIntoView(),scrollByOffset();else if(null!=n.previousElementSibling){i=n;let u=n.previousElementSibling;for(;u&&!u.matches(l.postSelector);)u=u.previousElementSibling;if(!u)return;u.scrollIntoView(),n==i&&(n=u),scrollByOffset()}n.focus(),l.scrollCallback&&l.scrollCallback()}else"."===a?(window.scrollTo({top:0,behavior:"smooth"}),n=t[0],l.scrollCallback&&l.scrollCallback()):null!=l.reblogSelector&&e.shiftKey&&"R"===a?n.querySelector(l.reblogSelector)?.click():null!=s&&"?"===a?(l.searchCallback&&l.searchCallback(),s.focus(),e.preventDefault()):null==r||document.body.classList.contains("lightboxed")||document.querySelector("dialog[open]")||"ArrowRight"!==e.key?null==c||document.body.classList.contains("lightboxed")||document.querySelector("dialog[open]")||"ArrowLeft"!==e.key?null!=l.paletteToggleSelector&&e.shiftKey&&"P"===a&&document.querySelector(l.paletteToggleSelector).click():c.click():r.click()}})}